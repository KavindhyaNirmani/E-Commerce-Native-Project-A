<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gather and Grab</title>
    <link rel="icon" type="image/png" href="./assets/images/logo.png" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./assets/styles/cart.css" />
    <!-- Google font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font-Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <!-- jQuery -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      crossorigin="anonymous"
    ></script>
    <!-- Popper.js and Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body
    style="
      font-family: 'Lato', sans-serif;
      background-image: none;
      height: 100%;
    "
  >
    <!-- Navbar -->
    <div id="headerPlaceholder"></div>

    <script>
      fetch("./assets/widgets/header.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("headerPlaceholder").innerHTML = data;
          const offcanvasNavbar = document.getElementById("offcanvasNavbar");
          offcanvasNavbar.style.backgroundColor = "black";
        })
        .catch((error) => console.error("Error loading header:", error));
    </script>

    <div class="container">
      <div class="row">
        <!-- Cart table -->
        <div class="col-lg-8">
          <table id="cart-table" class="table table-striped">
            <thead>
              <tr>
                <th>Select</th>
                <th></th>
                <th>Item</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Total</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody id="cart-items"></tbody>
          </table>
          <button
            class="btn-add"
            onclick="window.location.href='index.html#menu'"
          >
            Add item
          </button>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
          <div class="order-summary">
            <h4>Order Summary</h4>
            <table>
              <tr>
                <td>No. of Items</td>
                <td>:</td>
                <td><span id="item-count">0</span></td>
              </tr>
              <tr>
                <td>Sub Total</td>
                <td>:</td>
                <td>Rs.<span id="sub-total">0.00</span></td>
              </tr>
              <tr>
                <td>Discount</td>
                <td>:</td>
                <td>Rs.<span id="discount">0.00</span></td>
              </tr>
              <tr>
                <td colspan="3"><hr class="full-width-line" /></td>
              </tr>
              <tr>
                <td><strong>Total </strong></td>
                <td>:</td>
                <td>
                  <strong>Rs. <span id="total">0.00</span></strong>
                </td>
              </tr>
            </table>
            <button class="btn-checkout" onclick="passItemsToCheckout()">
              Proceed to Checkout
            </button>
            <script>
              function passItemsToCheckout() {
                window.location.href = "checkout.html";
              }
            </script>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Section -->
    <div id="footerPlaceholder"></div>
    <script>
      fetch("./assets/widgets/footer.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("footerPlaceholder").innerHTML = data;
        })
        .catch((error) => console.error("Error loading footer:", error));
    </script>

    <script>
      async function fetchCartItems() {
        const token = localStorage.getItem("authToken");

        if (!token) {
          document.getElementById("cart-message").textContent =
            "You need to log in to view your cart.";
          return;
        }

        try {
          const response = await fetch("https://ecom-back-t1.netfy.app/cart", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            const errorResponse = await response.text();
            console.error("Error fetching cart items:", errorResponse);
            document.getElementById(
              "cart-message"
            ).textContent = `Error fetching cart items: ${errorResponse}`;
            return;
          }

          const cartItems = await response.json();
          displayCartItems(cartItems.items);
        } catch (error) {
          console.error("There was an error fetching cart items:", error);
          document.getElementById("cart-message").textContent =
            "There was an error fetching cart items. Please try again.";
        }
      }

      function displayCartItems(items) {
        const cartItemsContainer = document.getElementById("cart-items");
        cartItemsContainer.innerHTML = "";

        if (items.length === 0) {
          cartItemsContainer.innerHTML =
            "<tr><td colspan='7'>Your cart is empty.</td></tr>";
          return;
        }

        items.forEach((item) => {
          const quantity = item.quantity || 1;
          const itemTotal = parseFloat(item.item_price) * quantity;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="checkbox" class="item-checkbox" data-id="${
              item.cart_item_id
            }" data-price="${item.item_price}" /></td>
            <td><img src="https://ecom-back-t1.netfy.app${
              item.item_image
            }" alt="${item.item_name}" style="width: 50px; height: 50px;"></td>
            <td>${item.item_name}</td>
            <td>Rs: ${item.item_price}</td>
            <td>
              <button onclick="changeQuantity(${
                item.cart_item_id
              }, -1)" class="btn btn-sm btn-secondary">-</button>
              <span id="quantity-${item.cart_item_id}">${quantity}</span>
              <button onclick="changeQuantity(${
                item.cart_item_id
              }, 1)" class="btn btn-sm btn-secondary">+</button>
            </td>
            <td>Rs: <span id="total-${item.cart_item_id}">${itemTotal.toFixed(
            2
          )}</span></td>
            <td><button class="btn btn-danger" onclick="removeItem(${
              item.cart_item_id
            })">Remove</button></td>
          `;
          cartItemsContainer.appendChild(row);
        });

        updateOrderSummary();

        document.querySelectorAll(".item-checkbox").forEach((checkbox) => {
          checkbox.addEventListener("change", updateOrderSummary);
        });
      }

      function updateOrderSummary() {
        let selectedItems = document.querySelectorAll(".item-checkbox:checked");
        let total = 0;
        let itemCount = selectedItems.length;

        selectedItems.forEach((item) => {
          const id = item.getAttribute("data-id");
          const price = parseFloat(item.getAttribute("data-price"));
          const quantity = parseInt(
            document.getElementById(`quantity-${id}`).textContent
          );
          total += price * quantity;
        });

        document.getElementById("item-count").textContent = itemCount;
        document.getElementById("sub-total").textContent = total.toFixed(2);
        document.getElementById("total").textContent = total.toFixed(2);
      }

      async function changeQuantity(cartItemId, change) {
        const token = localStorage.getItem("authToken");
        if (!token) {
          alert("You need to log in to change item quantities.");
          return;
        }

        const quantityElement = document.getElementById(
          `quantity-${cartItemId}`
        );
        let currentQuantity = parseInt(quantityElement.textContent);
        currentQuantity += change;

        if (currentQuantity < 1) return; // Prevents negative quantity

        try {
          const response = await fetch(
            `https://ecom-back-t1.netfy.app/cart/update/${cartItemId}`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ quantity: currentQuantity }),
            }
          );

          if (!response.ok) {
            const errorResponse = await response.text();
            console.error("Error updating item quantity:", errorResponse);
            alert("Error updating item quantity. Please try again.");
            return;
          }

          quantityElement.textContent = currentQuantity;
          const itemPrice = parseFloat(
            document.querySelector(`[data-id="${cartItemId}"]`).dataset.price
          );
          document.getElementById(`total-${cartItemId}`).textContent = (
            currentQuantity * itemPrice
          ).toFixed(2);
          updateOrderSummary();
        } catch (error) {
          console.error("Error updating item quantity:", error);
          alert("Error updating item quantity. Please try again.");
        }
      }

      async function removeItem(cartItemId) {
        const token = localStorage.getItem("authToken");
        if (!token) {
          alert("You need to log in to remove items from the cart.");
          return;
        }

        try {
          const response = await fetch(
            `https://ecom-back-t1.netfy.app/cart/delete/${cartItemId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            const errorResponse = await response.text();
            console.error("Error deleting cart item:", errorResponse);
            alert("Error deleting item. Please try again.");
            return;
          }

          fetchCartItems();
        } catch (error) {
          console.error("Error deleting cart item:", error);
          alert("Error deleting item. Please try again.");
        }
      }

      fetchCartItems();

      // Define the function to get selected items
      function getSelectedItems() {
        const selectedItems = [];
        const checkboxes = document.querySelectorAll(".item-checkbox:checked");

        checkboxes.forEach((checkbox) => {
          const id = checkbox.getAttribute("data-id");
          const price = parseFloat(checkbox.getAttribute("data-price"));
          const quantity = parseInt(
            document.getElementById(`quantity-${id}`).textContent
          );
          const itemName = checkbox
            .closest("tr")
            .querySelector("td:nth-child(3)").textContent;

          selectedItems.push({
            cart_item_id: id,
            item_name: itemName,
            item_price: price,
            quantity: quantity,
          });
        });

        return selectedItems;
      }

      // Define the function to pass items to checkout
      async function passItemsToCheckout() {
        // Fetch selected items; ensure this function returns the correct structure
        const selectedItems = getSelectedItems();
        const token = localStorage.getItem("authToken");

        if (!token) {
          alert("You need to log in to proceed to checkout.");
          return;
        }

        // Check if there are items selected for checkout
        if (!selectedItems || selectedItems.length === 0) {
          alert("Please select items to proceed to checkout.");
          return;
        }

        try {
          const response = await fetch(
            "https://ecom-back-t1.netfy.app/orders/checkout/transfer-selected",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                selectedCartItemIds: selectedItems.map(
                  (item) => item.cart_item_id
                ),
              }), // Use only cart_item_id
            }
          );

          if (!response.ok) {
            const errorResponse = await response.json();
            console.error(
              "Error transferring items to checkout:",
              errorResponse
            );
            alert(
              errorResponse.error ||
                "Error proceeding to checkout. Please try again."
            );
            return;
          }

          // Redirect to checkout page after successful transfer
          window.location.href = "checkout.html";
        } catch (error) {
          console.error("Error transferring items to checkout:", error);
          alert("Error proceeding to checkout. Please try again.");
        }
      }
    </script>
  </body>
</html>
