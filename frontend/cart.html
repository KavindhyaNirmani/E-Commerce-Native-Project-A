<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gather and Grab - Cart</title>
    <link rel="icon" type="image/png" href="./assets/images/logo.png" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./assets/styles/cart.css" />
    <!-- Google font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font-Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <!-- jQuery -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      crossorigin="anonymous"
    ></script>
    <!-- Popper.js and Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
    <script defer src="./cart-controller.js"></script> <!-- Reference JS file for functionality -->
  </head>
  <body
    style="font-family: 'Lato', sans-serif; background-image: linear-gradient(#6c6a6a, #1e1e1e); height: 100vh;"
  >
    <div class="container">
      <div class="row">
        <!-- Cart table -->
        <div class="col-lg-8">
          <h3>My Cart</h3>
          <p id="cart-message" class="empty-cart-message">Your Cart is Empty</p>
          <table id="cart-table" class="table table-striped">
            <thead>
              <tr>
                <th></th>
                <th>Item</th>
                <th></th>
                <th>Qty</th>
                <th>Total</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody id="cart-items"></tbody>
          </table>
          <button class="btn-add" onclick="window.location.href='index.html#menu'">Add item</button>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
          <div class="order-summary">
            <h4>Order Summary</h4>
            <table>
              <tr>
                <td>No. of Items</td>
                <td>:</td>
                <td><span id="item-count">0</span></td>
              </tr>
              <tr>
                <td>Sub Total</td>
                <td>:</td>
                <td>Rs.<span id="sub-total">0.00</span></td>
              </tr>
              <tr>
                <td>Discount</td>
                <td>:</td>
                <td>Rs.<span id="discount">0.00</span></td>
              </tr>
              <tr>
                <td colspan="3"><hr class="full-width-line" /></td>
              </tr>
              <tr>
                <td><strong>Total </strong></td>
                <td>:</td>
                <td><strong>Rs. <span id="total">0.00</span></strong></td>
              </tr>
            </table>
            <button class="btn-checkout" onclick="passItemsToCheckout()">Proceed to Checkout</button>
          </div>
        </div>
      </div>
    </div>

    <script>
   
      async function fetchCartItems() {
           const token = localStorage.getItem("token");
   
           if (!token) {
             document.getElementById("cart-message").textContent = "You need to log in to view your cart.";
             return;
           }
   
           try {
             const response = await fetch("https://ecom-back-t1.netfy.app/cart", {
               method: "GET",
               headers: {
                 "Authorization": `Bearer ${token}`
               }
             });
   
             console.log('Fetch Cart Items Response Status:', response.status);
             const errorResponse = await response.text(); // Get response text for debugging
             if (!response.ok) {
               console.error('Error fetching cart items:', errorResponse);
               document.getElementById("cart-message").textContent = `Error fetching cart items: ${errorResponse}`;
               return;
             }
   
             const cartItems = JSON.parse(errorResponse); // Use the text response to parse JSON
             console.log('Fetched Cart Items:', cartItems);
             displayCartItems(cartItems.items);
           } catch (error) {
             console.error('There was an error fetching cart items:', error);
             document.getElementById("cart-message").textContent = "There was an error fetching cart items. Please try again.";
           }
         }
   
         function displayCartItems(items) {
           const cartItemsContainer = document.getElementById("cart-items");
           cartItemsContainer.innerHTML = ""; // Clear previous items
   
           if (items.length === 0) {
             cartItemsContainer.innerHTML = "<tr><td colspan='6'>Your cart is empty.</td></tr>";
             return;
           }
   
           let total = 0; // Initialize total
           items.forEach(item => {
             const quantity = item.quantity || 0; // Default to 0 if null
             const itemTotal = parseFloat(item.item_price) * quantity; // Calculate total for this item
             total += itemTotal; // Add to overall total
   
             const row = document.createElement("tr");
             row.innerHTML = `
               <td><img src="https://ecom-back-t1.netfy.app${item.item_image}" alt="${item.item_name}" style="width: 50px; height: 50px;"></td>
               <td>${item.item_name}</td>
               <td>Rs: ${item.item_price}</td>
               <td>${quantity}</td>
               <td>Rs: ${itemTotal.toFixed(2)}</td>
               <td><button class="btn btn-danger" onclick="removeItem(${item.cart_item_id})">Remove</button></td>
             `;
             cartItemsContainer.appendChild(row);
           });
   
           // Update summary
           document.getElementById("item-count").textContent = items.length;
           document.getElementById("sub-total").textContent = total.toFixed(2);
           document.getElementById("total").textContent = total.toFixed(2);
         }
   
         // Call the fetch function when the page loads
         window.onload = function() {
           fetchCartItems();
         };
   
         function removeItem(cartItemId) {
           // Implement removal logic
           console.log("Remove item with ID:", cartItemId);
           // Optionally refresh cart after removal
           fetchCartItems();
         }
       </script>
   
  </body>
</html>
