<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gather and Grab</title>
    <link
      rel="icon"
      type="image/png"
      sizes="64x64"
      href="./assets/images/logo.png?v=1"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <!--Custom CSS-->
    <link rel="stylesheet" href="./assets/styles/card.css" />
  </head>

  <body
    style="background-image: linear-gradient(#6c6a6a, #1e1e1e); height: 100%"
  >
    <div id="topBar"></div>
    <!-- Navbar -->
    <div id="headerPlaceholder"></div>

    <script>
      fetch("./assets/widgets/header.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("headerPlaceholder").innerHTML = data;
          // Ensure the offcanvas background color is set after loading
          const offcanvasNavbar = document.getElementById("offcanvasNavbar");
          if (offcanvasNavbar) {
            offcanvasNavbar.style.backgroundColor = "black";
          }
        })
        .catch((error) => console.error("Error loading header:", error));
    </script>

    <!-- Hero Section -->
    <section class="hero">
      <img
        src="./assets/images/pizza-bg-img.jpg"
        alt="Pizza Background"
        class="hero-img"
      />
      <h1 class="hero-text">The Art of Refreshment, One Sip at a Time</h1>
    </section>

    <!-- Features Section -->
    <section class="features">
      <div class="feature">
        <img src="./assets/images/feature-pizza.png" alt="Pizza" />
        <h3>Fresh Pizza</h3>
        <p>We serve fresh, hand-tossed pizza with authentic ingredients.</p>
      </div>
      <div class="feature">
        <img src="./assets/images/feature-delivery.png" alt="Delivery" />
        <h3>Fast & Fresh Delivery</h3>
        <p>
          Get your pizzas delivered fresh and fast to satisfy your cravings.
        </p>
      </div>
      <div class="feature">
        <img src="./assets/images/feature-dessert.png" alt="Dessert" />
        <h3>Sweet Desserts</h3>
        <p>Our sweet treats will give you the perfect end to your meal.</p>
      </div>
    </section>

    <!-- Pizza Menu Section -->
    <div class="container my-5">
      <div class="row" id="pizzaMenu"></div>

      <!-- Container to align buttons left and right -->
      <div class="button-container">
        <button
          id="backBtn"
          class="back-btn"
          onclick="window.location.href='./index.html#menu';"
        >
          Back
        </button>

        <button id="viewMoreBtn" class="view-all-btn">View More</button>
      </div>
    </div>

    <!-- Footer Section -->
    <div id="footerPlaceholder"></div>
    <script>
      fetch("./assets/widgets/footer.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("footerPlaceholder").innerHTML = data;
        })
        .catch((error) => console.error("Error loading footer:", error));
    </script>

    <!-- JS to load pizza items dynamically and handle "View More" functionality -->
    <script>
      let allPizzaData = []; // Store all pizza items
      let pizzaLimit = 4; // Initial limit for items to display

      // Fetch all pizza items and store them
      fetch("https://ecom-back-t1.netfy.app/items/category/pizza")
        .then((response) => response.json())
        .then((data) => {
          allPizzaData = data;
          displayPizzaItems(allPizzaData.slice(0, pizzaLimit)); // Show only limited items initially
        })
        .catch((error) => console.error("Error loading menu data:", error));

      // Function to display pizza items dynamically
      function displayPizzaItems(items) {
        const menu = document.getElementById("pizzaMenu");
        items.forEach((item) => {
          const menuItem = document.createElement("div");
          menuItem.classList.add("col-md-3", "col-sm-6", "mb-4"); // Bootstrap grid classes
          menuItem.innerHTML = `
                    <div class="menu-item">
                        <img src="https://ecom-back-t1.netfy.app${
                          item.item_image
                        }" alt="${item.item_name}" >
                        <div class="card-body d-flex flex-column">
                            <h4 >${item.item_name}</h4>
                            <h5 >Rs: ${item.item_price}</h5>
                            <p >${item.item_description}</p>
                            <button class="add-to-cart" data-item='${JSON.stringify(
                              item
                            )}'>Add to Cart</button>
                        </div>
                    </div>
                `;
          menu.appendChild(menuItem);
        });
        document.querySelectorAll(".add-to-cart").forEach((button) => {
                button.addEventListener("click", handleAddToCart);
            });
        
      }

      // Handle "View More" button click
      document
        .getElementById("viewMoreBtn")
        .addEventListener("click", function () {
          const additionalItems = allPizzaData.slice(
            pizzaLimit,
            pizzaLimit + 8
          ); // Load 8 more items
          displayPizzaItems(additionalItems); // Display more items
          pizzaLimit += 8; // Update limit to reflect more items being shown

          // Hide button if all items are displayed
          if (pizzaLimit >= allPizzaData.length) {
            document.getElementById("viewMoreBtn").style.display = "none";
          }
        });
        
        async function handleAddToCart(event) {
            const item = JSON.parse(event.target.getAttribute("data-item"));
            const token = localStorage.getItem("token");

            if (!token) {

                localStorage.setItem("redirectAfterLogin", "index.html#menu");
                window.location.href = "user-reg.html";
                return;
            }

            await addToCart(item);
        }

        async function addToCart(item) {
            const token = localStorage.getItem("token");
            console.log('Adding item to cart:', item);
            console.log('Using token:', token);

            try {
                const response = await fetch("https://ecom-back-t1.netfy.app/cart/add", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        item_id: item.item_id,
                    })
                });

                console.log('Response Status:', response.status);

                if (!response.ok) {
                    const errorResponse = await response.json();
                    console.error('Error Response:', errorResponse);
                    alert(`Error adding item to cart: ${errorResponse.message || "Unknown error"}`);
                    throw new Error('Error adding item to cart');
                }

                const responseData = await response.json();
                console.log('Response Data:', responseData);
                alert(`${item.item_name} has been added to your cart.`);

                // Redirect to the cart page after successfully adding the item
                window.location.href = "cart.html"; // Redirect to cart after successful addition
            } catch (error) {
                console.error('There was an error adding the item to your cart:', error);
                alert("There was an error adding the item to your cart. Please try again.");
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
