<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gather and Grab</title>
    <link rel="icon" type="image/png" href="./assets/images/logo.png?v=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />

    <!--Custom CSS-->
    <link rel="stylesheet" href="./assets/styles/card.css" />
    <link rel="stylesheet" href="./assets/widgets/cake-hero.css" />
  </head>

  <body style="background-image: none">
    <!-- Navbar -->
    <div id="headerPlaceholder"></div>

    <script>
      fetch("./assets/widgets/header.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("headerPlaceholder").innerHTML = data;
          // Ensure the offcanvas background color is set after loading
          const offcanvasNavbar = document.getElementById("offcanvasNavbar");
          offcanvasNavbar.style.backgroundColor = "black";
        })
        .catch((error) => console.error("Error loading header:", error));
    </script>

    <!-- Hero Section -->
    <div class="hero-image">
      <div class="hero-text">
        <h1>Savor the Sweetness, Celebrate the Moments</h1>
    <p>Delicious Cakes Crafted for Every Occasion</p>
      </div>
    </div>
   
     <!--Features section-->
    <feature-section></feature-section>

    <!-- Pizza Menu Section -->
    <div class="container my-5">
      <div class="row" id="cakeMenu"></div>

      <!-- Container to align buttons left and right -->
      <div class="button-container">
        <a href="./index.html#menu" class="btn btn-secondary-previous">
            &laquo; Previous
        </a>
        <a id="viewMoreBtn" class="btn btn-secondary-next">
            Next &raquo;
        </a>
    </div>
    </div>

    <!-- Footer Section -->
    <div id="footerPlaceholder"></div>
    <script>
      fetch("./assets/widgets/footer.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("footerPlaceholder").innerHTML = data;
        })
        .catch((error) => console.error("Error loading footer:", error));

      let allCakeData = [];
      let cakeLimit = 3;

      fetch("https://ecom-back-t1.netfy.app/items/category/cake")
        .then((response) => response.json())
        .then((data) => {
          allCakeData = data;
          displayCakeItems(allCakeData.slice(0, cakeLimit));
        })
        .catch((error) => console.error("Error loading menu data:", error));

      function displayCakeItems(items) {
        const menu = document.getElementById("cakeMenu");
        items.forEach((item) => {
          const menuItem = document.createElement("div");
          menuItem.classList.add("col-lg-4", "col-md-6", "mb-4");
          menuItem.innerHTML = `
                    <div class="card-container">
                      <div class="food-card">
                        <div class="image-container">
                        <img src="https://ecom-back-t1.netfy.app${
                          item.item_image
                        }" alt="${item.item_name}" >
                        <div class="overlay">
                          <p>${item.item_description}</p>
                          </div>
                          </div>
                            <div class="item-name"><h5>${
                              item.item_name
                            }</h5></div>
                            <div class="item-price"><h6>Rs: ${
                              item.item_price
                            }</h6></div>
                            
                            <button class="order-btn" data-item='${JSON.stringify(
                              item
                            )}'>Order Now</button>
                       </div>
                       </div> 
                    </div>
                `;
          menu.appendChild(menuItem);
        });

        document.querySelectorAll(".order-btn").forEach((button) => {
          button.addEventListener("click", handleAddToCart);
        });
      }

      document
        .getElementById("viewMoreBtn")
        .addEventListener("click", function () {
          const additionalItems = allCakeData.slice(cakeLimit, cakeLimit + 8);
          displayCakeItems(additionalItems);
          cakeLimit += 8;
          if (cakeLimit >= allCakeData.length) {
            document.getElementById("viewMoreBtn").style.display = "none";
          }
        });

      async function handleAddToCart(event) {
        const item = JSON.parse(event.target.getAttribute("data-item"));
        const token = localStorage.getItem("authToken");

        if (!token) {
          localStorage.setItem("redirectAfterLogin", "index.html#menu");
          window.location.href = "user-reg.html";
          return;
        }

        await addToCart(item);
      }

      async function addToCart(item) {
        const token = localStorage.getItem("authToken");
        console.log("Adding item to cart:", item);
        console.log("Using token:", token);

        try {
          const response = await fetch(
            "https://ecom-back-t1.netfy.app/cart/add",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                item_id: item.item_id,
              }),
            }
          );

          console.log("Response Status:", response.status);

          if (!response.ok) {
            const errorResponse = await response.json();
            console.error("Error Response:", errorResponse);
            alert(
              `Error adding item to cart: ${
                errorResponse.message || "Unknown error"
              }`
            );
            throw new Error("Error adding item to cart");
          }

          const responseData = await response.json();
          console.log("Response Data:", responseData);
          alert(`${item.item_name} has been added to your cart.`);

          // Redirect to the cart page after successfully adding the item
          window.location.href = "cart.html"; // Redirect to cart after successful addition
        } catch (error) {
          console.error(
            "There was an error adding the item to your cart:",
            error
          );
          alert(
            "There was an error adding the item to your cart. Please try again."
          );
        }
      }
    </script>
     <!-- Custom JS -->
    <script src="./assets/js/feature-cake.js"></script>
     
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
